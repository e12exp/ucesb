
OBJS    = rfcat.o

ALL_OBJS = $(OBJS) $(GENOBJS)

AUTO_DEPS = $(ALL_OBJS:%.o=%.d)

CXXLINK = $(CXX)

CXXFLAGS += -g -I. -I../common # so autogenerated files find includes
CXXFLAGS += # -ansi , troubles with strdup and fileno
CXXFLAGS += -O3
CXXFLAGS += -DUCESB_SRC

CXXFLAGS += -ansi

USE_RAWAPI=1
CXXFLAGS     += -DUSE_RAWAPI=$(USE_RAWAPI)

#####################################################################

FILE_CURSES_CONFIG=$(shell which ncurses5-config 2> /dev/null)

ifneq (,$(FILE_CURSES_CONFIG))
CXXFLAGS     += -DUSE_CURSES=$(USE_CURSES) \
        $(shell $(FILE_CURSES_CONFIG) --cflags)
CXXLIBS      += $(shell $(FILE_CURSES_CONFIG) --libs)
else 
ifdef USE_CURSES
CXXFLAGS     += -DUSE_CURSES=$(USE_CURSES)
CXXLIBS      += -lcurses
endif
endif

#####################################################################

# Default target

all: rfcat

# Cleanup

clean:
	rm -f $(ALL_OBJS)
	rm -f $(AUTO_DEPS)
	rm -f rfcat.base.dep
	rm -f rfcat.dep
	rm -f rfcat

# Create the autogenerated files (lexer, parser)

%.o: %.cc %.d
	@echo "   CXX   $@"
	@$(CXX) $(CXXFLAGS) $(OPTFLAGS) -o $@ -c $<

%.d: %.cc
	@echo "  DEPS   $@"
	@$(CXX) $(CXXFLAGS) -MM -MG $< | \
	  sed -e 's,\($(*F)\)\.o[ :]*,$*.o $@ : ,g' \
	> $@

include ../makefile_deps.inc
include ../makefile_filter_warnings.inc
include ../makefile_rawapi.inc

rfcat.dep: $(AUTO_DEPS)
	@echo " FULLDEP $@"
	@echo "$@ $(MAKECMDGOALS): \\" > $@
	@cat $(AUTO_DEPS) | sed -e 's,^.*:,,g' |\
          sed -e 's,^#.*,,g' |\
          sed -e 's,^.*:,,g' |\
	  $(SPACE_TO_NEWLINE) |\
	  sed -e 's,^,  ,g' |\
	  sed -e 's,$$,\\,g' |\
	  sed -e 's,\\\\$$,\\,g' | sort -u >> $@

#

rfcat.base.dep: rfcat.dep
	@echo " BASEDEP $@"
	@echo '$$(UCESB_BASE_DIR)/rfiocmd/$(MAKECMDGOALS): \\' > $@
	@cat $< | grep -v ' \\' | sed -e 's,  /, /,' -e 's,  ,  $$\(UCESB_BASE_DIR\)/rfiocmd/,g' | sort -u >> $@

#
# Link

rfcat: $(ALL_OBJS) rfcat.dep rfcat.base.dep
	@echo "  LINK   $@"
	@$(CXXLINK) $(CXXLINKFLAGS) $(ALL_OBJS) $(CXXLIBS) -o $@

ifneq (clean,$(MAKECMDGOALS))
-include $(AUTO_DEPS) # dependency files (.d)
endif

